CREATE EVENT SESSION DeadlockTracking
ON SERVER
ADD EVENT sqlserver.xml_deadlock_report
ADD TARGET package0.event_file (SET filename = 'C:\DeadlockLogs\Deadlocks.xel')
WITH (STARTUP_STATE = ON);

GO

ALTER EVENT SESSION DeadlockTracking ON SERVER STATE = START;


SELECT * 
FROM sys.fn_xe_file_target_read_file('C:\DeadlockLogs\Deadlocks*.xel', NULL, NULL, NULL);




CREATE PROCEDURE dbo.SendDeadlockAlert
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @body NVARCHAR(MAX);

    -- Get the latest deadlock information
    SELECT @body = STRING_AGG(CONVERT(NVARCHAR(MAX), event_data), CHAR(10))
    FROM sys.fn_xe_file_target_read_file('C:\DeadlockLogs\Deadlocks*.xel', NULL, NULL, NULL);

    -- Send Email Notification
    EXEC msdb.dbo.sp_send_dbmail
        @profile_name = 'YourMailProfile',  -- Replace with your Database Mail profile name
        @recipients = 'your.email@example.com', -- Replace with recipient email
        @subject = 'Deadlock Alert in SQL Server',
        @body = @body;
END
GO


EXEC dbo.SendDeadlockAlert;
