USE [DBA]
GO

-- Create the table to store captured sessions
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'SessionAudit')
BEGIN
    CREATE TABLE dbo.SessionAudit (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        Loginname SYSNAME,
        Hostname VARCHAR(200),
        Databasename SYSNAME,
        Programname VARCHAR(200),
        SessionID INT,
        StartTime DATETIME,
        SQLText XML NULL,
        QueryDuration VARCHAR(256),
        InsertedDate DATETIME DEFAULT GETDATE()
    );
END

GO

-- Create the stored procedure to capture active sessions
CREATE PROCEDURE dbo.CaptureActiveSessions
AS
BEGIN
    SET NOCOUNT ON;

    -- Temporary table for storing session details
    IF OBJECT_ID('tempdb..#SessionTemp') IS NOT NULL
        DROP TABLE #SessionTemp;

    CREATE TABLE #SessionTemp (
        Loginname SYSNAME,
        Hostname VARCHAR(200),
        Databasename SYSNAME,
        Programname VARCHAR(200),
        SessionID INT,
        StartTime DATETIME,
        SQLText XML NULL,
        QueryDuration VARCHAR(256)
    );

    -- Capture active sessions using sp_WhoIsActive
    EXEC [dbo].[sp_WhoIsActive] 
        @show_sleeping_spids = 2, 
        @output_column_list = '[login_name][host_name][database_name][program_name][session_id][start_time][sql_text][dd%]', 
        @destination_table = '#SessionTemp';

    -- Insert the captured data into the permanent audit table
    INSERT INTO dbo.SessionAudit (
        Loginname, Hostname, Databasename, Programname, 
        SessionID, StartTime, SQLText, QueryDuration
    )
    SELECT 
        Loginname, Hostname, Databasename, Programname, 
        SessionID, StartTime, SQLText, QueryDuration
    FROM #SessionTemp;

    -- Optional: Display the captured sessions
    SELECT * FROM dbo.SessionAudit ORDER BY InsertedDate DESC;
END

GO

-- To execute and capture sessions, simply run:
EXEC dbo.CaptureActiveSessions;
